@page "/login"
@attribute [AllowAnonymous]



<EditForm class="m-auto" Model="_model">
    <section class="flex-col flex-around account-login">
        <h1>Login</h1>
        <span class="subtitle">email</span>
        <InputText typeof="email" placeholder="homecook@enplace.com" class="blade-control" @bind-Value="_model.Email" DisplayName="Email" />
        <span class="subtitle">password</span>
        <InputText class="blade-control" placeholder="********" type="password" @bind-Value="_model.Credentials" DisplayName="Password" />
        <div class="flex-row flex-between gap-s">
            <button class="btn btn-primary" @onclick="() => AuthorizeUser()">
                Log In
            </button>
            <button class="btn btn-secondary" @onclick="() => RegisterUser()">
                Create New Account
            </button>
        </div>
    </section>
</EditForm>


@code {
    [Inject]
    public AuthService Auth { get; set; }
    [Inject]
    public AuthenticationStateProvider AuthProvider { get; set; }

    [Inject]
    public NavigationManager NavigationManager { get; set; }

    [Inject]
    public ILocalStorageService Storage { get; set; }

    private AuthRequest _model = new();

    public async void AuthorizeUser()
    {
        var response = await Auth.AuthenticateUser(_model);
        if (response is not null)
        {
            var dto = await Auth.AuthenticateAPI(response.Token);
            Console.WriteLine(dto.Name);
            Console.WriteLine(dto.Id);
            EnplaceContext.User = dto;
            HandleToken(response.Token);
        }
        else
        {
            // Notify User
        }
    }

    public async void RegisterUser()
    {
        var response = await Auth.RegisterUser(_model);
        if (response is not null)
        {
            EnplaceContext.User = await Auth.RegisterAPI(response.Token);
            HandleToken(response.Token);
        }
        else
        {
            // Notify User
        }
    }

    private void HandleToken(string token)
    {
        if (Auth.IsTokenValid(token))
        {
            EnplaceContext.Token = token;
            Storage.SetItemAsStringAsync("skid.enplace", token);


            StateHasChanged();
            AuthProvider.GetAuthenticationStateAsync();
            NavigationManager.NavigateTo("/");
        }
        else
        {
            // Notify user
        }
    }
}
